# 要件定義書 - ナレッジ修正案承認システム

## 1. 目的

独立したナレッジ修正案承認システムとして、既存のナレッジコンテンツに対する修正提案を体系的に管理し、承認グループベースの承認プロセスを通じてナレッジの品質向上を図る。

## 2. 機能要件

### 2.1 ユーザー管理機能（実装済み）

- **ユーザー認証**: JWT トークンベース認証
- **役割管理**: user（一般ユーザー）、approver（承認者）、admin（管理者）
- **承認グループ管理**: ユーザーを承認グループに所属させ、責任範囲を明確化

### 2.2 記事管理機能（実装済み）

- **記事登録**: 外部システムから独立した記事参照情報の管理
- **承認グループ割当**: 記事ごとに担当承認グループを指定
- **記事情報**: タイトル、カテゴリ、キーワード、重要度、公開期間等を管理

### 2.3 修正案管理機能（実装済み）

- **修正案作成**: After-only形式での修正案作成（修正前データは保持せず、修正後データのみ）
- **修正案提出**: draft → submitted への状態遷移
- **修正案更新**: draft状態でのみ編集可能
- **修正案撤回**: submitted状態からの撤回機能
- **修正案削除**: draft状態での削除機能

#### 修正可能フィールド
- タイトル（after_title）
- 情報カテゴリ（after_info_category）
- キーワード（after_keywords）
- 重要度（after_importance）
- 公開開始日（after_publish_start）
- 公開終了日（after_publish_end）
- 対象者（after_target）
- 質問（after_question）
- 回答（after_answer）
- 追加コメント（after_additional_comment）

### 2.4 承認ワークフロー機能（実装済み）

- **5段階ステータス管理**: draft → submitted → approved/rejected/deleted
- **承認者必須指定**: 修正案作成時に承認者を必須指定（approver_id）
- **承認・却下処理**: 承認者による承認・却下とコメント機能
- **承認権限制御**: 承認グループベースの承認権限管理

### 2.5 通知機能（実装済み）

- **基本通知システム**: 修正案の状態変化に応じた通知
- **通知履歴管理**: 通知の既読・未読管理
- **通知配信**: 提出時の承認者通知、承認・却下時の提出者通知

### 2.6 差分表示機能（実装済み）

- **フィールドレベル差分**: 修正前後の各フィールド比較
- **After-only対応**: 現在値（記事データ）と提案値（修正案データ）の比較
- **視覚的差分表示**: フロントエンドでの差分可視化

### 2.7 検索・フィルタリング機能（実装済み）

- **権限ベース表示**: 
  - 一般ユーザー: 自分の修正案のみ
  - 承認者: 担当グループの修正案
  - 管理者: 全修正案
- **ステータスフィルタ**: 修正案の状態による絞り込み
- **期間フィルタ**: 作成日時による絞り込み

## 3. 非機能要件

### 3.1 パフォーマンス

- **同時接続**: 100ユーザーの同時利用
- **応答時間**: 検索・表示は3秒以内
- **大容量対応**: 10MB以上のコンテンツでも5秒以内での差分表示

### 3.2 セキュリティ

- **認証**: JWT トークンベース認証
- **認可**: RBAC（Role-Based Access Control）
- **アクセス制御**: 修正案レベルでの細粒度制御
- **入力検証**: Pydantic による厳格な入力バリデーション
- **監査ログ**: 全操作のログ記録

### 3.3 保守性

- **モジュラー設計**: レイヤー分離アーキテクチャ
- **テスト**: pytest による包括的テスト
- **型安全**: TypeScript（フロントエンド）、SQLAlchemy 2.0 Mapped型（バックエンド）
- **API設計**: RESTful API with OpenAPI仕様

### 3.4 互換性

- **環境**: Windows Server 2019
- **ブラウザ**: Chrome、Firefox、Safari、Edge
- **レスポンシブ**: モバイル端末対応

## 4. 制約事項

### 4.1 技術的制約

- **OS**: Windows Server 2019（Docker非対応）
- **データベース**: PostgreSQL 17 + Redis 3.0.504
- **Redis制約**: 基本操作のみ利用可能（Streams、Modules等不可）
- **独立システム**: 既存システムとの統合不要

### 4.2 ビジネス制約

- **承認者事前指定**: 修正案作成時に承認者を必須指定
- **単一承認**: 1つの修正案に対して1人の承認者
- **After-only**: 修正前データは保持せず、修正後データのみ管理

## 5. システム構成

### 5.1 データベース設計（実装済み）

**コアエンティティ**:
- `users`: ユーザー管理（UUID PK、承認グループ所属）
- `approval_groups`: 承認グループ管理（UUID PK）
- `info_categories`: 情報カテゴリ管理（UUID PK）
- `articles`: 記事参照情報（文字列PK、承認グループ割当）

**ワークフローエンティティ**:
- `revisions`: 修正案管理（UUID PK、5段階ステータス、after-onlyフィールド、必須approver_id）
- `simple_notifications`: 通知管理（UUID PK）

### 5.2 API設計（実装済み）

**修正案API**: `/api/v1/revisions/*`
- GET `/` - 修正案一覧（権限ベース）
- GET `/{id}` - 修正案詳細
- POST `/` - 修正案作成
- PUT `/{id}` - 修正案更新
- DELETE `/{id}` - 修正案削除
- POST `/{id}/submit` - 修正案提出
- POST `/{id}/withdraw` - 修正案撤回

**承認API**: `/api/v1/approvals/*`
- POST `/{id}/decide` - 承認・却下処理
- GET `/{id}/status` - 承認状況取得
- GET `/queue` - 承認待ち一覧
- GET `/metrics` - 承認統計

**差分API**: `/api/v1/diffs/*`
- GET `/{id}` - 差分取得
- GET `/{id}/preview` - プレビュー表示

**その他API**:
- `/api/v1/users/*` - ユーザー管理
- `/api/v1/approval-groups/*` - 承認グループ管理
- `/api/v1/articles/*` - 記事管理
- `/api/v1/notifications/*` - 通知管理

## 6. 成功基準

### 6.1 完了の定義

- [x] 修正案の作成から承認までの全プロセスが動作
- [x] 承認グループベースの権限制御が動作
- [x] After-only形式での差分表示が動作
- [x] 通知システムが動作
- [x] RESTful API が完全実装
- [x] セキュリティ要件を満たす
- [ ] 包括的なテストが完了
- [ ] パフォーマンス要件を満たす
- [ ] フロントエンドUIが完成

### 6.2 受け入れテスト

- 修正案作成→提出→承認・却下の完全フローテスト
- 権限ベースアクセス制御のテスト
- 差分表示機能のテスト
- 通知機能のテスト
- パフォーマンス負荷テスト

## 7. 今後の課題

### 7.1 実装完了項目

- ✅ データベーススキーマ設計・実装
- ✅ バックエンドAPI実装（修正案管理、承認、差分、通知）
- ✅ 認証・認可システム
- ✅ After-only修正案システム
- ✅ 承認ワークフローエンジン

### 7.2 残課題

- フロントエンドUI完成度向上
- 包括的テストカバレッジ
- パフォーマンス最適化
- 運用監視機能
- ドキュメント整備

## 8. システムの特徴

### 8.1 After-only設計の利点

- シンプルなデータ構造
- 既存システムへの影響最小化
- 差分表示の高速化
- ストレージ効率化

### 8.2 承認者事前指定の利点

- 責任の明確化
- 承認プロセスの高速化
- 通知の適切な配信
- ワークフロー管理の簡素化

### 8.3 独立システムの利点

- 既存システムへの影響なし
- 段階的導入が可能
- システム固有の最適化
- 保守・運用の独立性